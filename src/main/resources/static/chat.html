<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¹´ì¹´ì˜¤í†¡ ìŠ¤íƒ€ì¼ ì±„íŒ…</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            height: 100vh;
            display: flex;
        }

        .container {
            display: flex;
            width: 100%;
            height: 100vh;
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }

        /* ì‚¬ì´ë“œë°” */
        .sidebar {
            width: 300px;
            background: #f8f9fa;
            border-right: 1px solid #e9ecef;
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding: 20px;
            background: #fee500;
            color: #3c1e1e;
            font-weight: bold;
            font-size: 18px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .refresh-button {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #3c1e1e;
            padding: 5px;
            border-radius: 50%;
            transition: background 0.2s;
        }

        .refresh-button:hover {
            background: rgba(0,0,0,0.1);
        }

        .refresh-button:active {
            transform: rotate(180deg);
            transition: transform 0.3s;
        }

        .user-info {
            padding: 15px 20px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #fee500;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #3c1e1e;
        }

        .room-list {
            flex: 1;
            overflow-y: auto;
        }

        .room-item {
            padding: 15px 20px;
            border-bottom: 1px solid #f1f3f4;
            cursor: pointer;
            transition: background 0.2s;
        }

        .room-item:hover {
            background: #f8f9fa;
        }

        .room-item.active {
            background: #fee500;
        }

        .room-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        .room-name {
            font-weight: 500;
            margin-bottom: 0;
        }

        .room-time {
            font-size: 12px;
            color: #999;
        }

        .room-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .room-last-message {
            font-size: 14px;
            color: #666;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex: 1;
            margin-right: 10px;
        }

        .unread-badge {
            background: #ff3b30;
            color: white;
            border-radius: 50%;
            min-width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            padding: 0 6px;
        }

        /* ë©”ì¸ ì±„íŒ… ì˜ì—­ */
        .chat-main {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .chat-header {
            padding: 15px 20px;
            background: #fee500;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .chat-title {
            font-weight: bold;
            color: #3c1e1e;
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #f8f9fa;
        }

        .message {
            margin-bottom: 15px;
            display: flex;
            align-items: flex-end;
            gap: 8px;
        }

        .message.own {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #fee500;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            color: #3c1e1e;
            flex-shrink: 0;
        }

        .message-content {
            max-width: 60%;
            padding: 10px 15px;
            border-radius: 18px;
            word-wrap: break-word;
        }

        .message.own .message-content {
            background: #fee500;
            color: #3c1e1e;
        }

        .message.other .message-content {
            background: white;
            color: #333;
            border: 1px solid #e9ecef;
        }

        .message-info {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-bottom: 5px;
            font-size: 12px;
        }

        .message.own .message-info {
            justify-content: flex-end;
        }

        .message-time {
            color: #999;
            font-size: 11px;
        }

        .message.own .message-time {
            text-align: right;
        }

        .system-message {
            text-align: center;
            color: #666;
            font-size: 12px;
            margin: 10px 0;
            padding: 5px;
            background: rgba(0,0,0,0.05);
            border-radius: 10px;
        }

        .typing-indicator {
            padding: 10px 20px;
            color: #666;
            font-style: italic;
            font-size: 14px;
        }

        .chat-input {
            padding: 20px;
            background: white;
            border-top: 1px solid #e9ecef;
        }

        .input-container {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .message-input {
            flex: 1;
            padding: 12px 15px;
            border: 1px solid #e9ecef;
            border-radius: 20px;
            resize: none;
            font-family: inherit;
            font-size: 14px;
            max-height: 100px;
            min-height: 40px;
        }

        .message-input:focus {
            outline: none;
            border-color: #fee500;
        }

        .send-button {
            padding: 12px 20px;
            background: #fee500;
            border: none;
            border-radius: 20px;
            color: #3c1e1e;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.2s;
        }

        .send-button:hover {
            background: #fdd835;
        }

        .send-button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .emoji-button {
            padding: 10px;
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #666;
        }

        .emoji-picker {
            position: absolute;
            bottom: 100px;
            right: 20px;
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 10px;
            display: none;
            grid-template-columns: repeat(6, 1fr);
            gap: 5px;
        }

        .emoji-picker.show {
            display: grid;
        }

        .emoji-item {
            padding: 5px;
            cursor: pointer;
            text-align: center;
            border-radius: 5px;
        }

        .emoji-item:hover {
            background: #f8f9fa;
        }

        /* ë¡œê·¸ì¸ í™”ë©´ */
        .login-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #fee500;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .login-form {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            text-align: center;
        }

        .login-form h1 {
            color: #3c1e1e;
            margin-bottom: 30px;
        }

        .login-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            margin-bottom: 15px;
            font-size: 16px;
        }

        .login-button {
            width: 100%;
            padding: 12px;
            background: #fee500;
            border: none;
            border-radius: 10px;
            color: #3c1e1e;
            font-weight: bold;
            font-size: 16px;
            cursor: pointer;
        }

        .hidden {
            display: none;
        }

        /* í† ìŠ¤íŠ¸ ë©”ì‹œì§€ */
        .toast-message {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #333;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 1000;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            max-width: 300px;
            word-wrap: break-word;
            cursor: pointer;
            border-left: 4px solid #fee500;
        }

        .toast-message:hover {
            background: #444;
            transform: translateX(0) scale(1.02);
        }

        .toast-message.show {
            transform: translateX(0);
        }

        /* ì• ë‹ˆë©”ì´ì…˜ ì¶”ê°€ */
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
    </style>
</head>
<body>
    <!-- ë¡œê·¸ì¸ í™”ë©´ -->
    <div id="loginScreen" class="login-screen">
        <div class="login-form">
            <h1>ì¹´ì¹´ì˜¤í†¡ ìŠ¤íƒ€ì¼ ì±„íŒ…</h1>
            <input type="text" id="userIdInput" class="login-input" placeholder="ì‚¬ìš©ì ID" />
            <input type="text" id="usernameInput" class="login-input" placeholder="ì‚¬ìš©ì ì´ë¦„" />
            <button onclick="login()" class="login-button">ë¡œê·¸ì¸</button>
        </div>
    </div>

    <!-- ë©”ì¸ ì±„íŒ… í™”ë©´ -->
    <div id="chatContainer" class="container hidden">
        <!-- ì‚¬ì´ë“œë°” -->
        <div class="sidebar">
            <div class="sidebar-header">
                <span>ì±„íŒ…ë°© ëª©ë¡</span>
                <button class="refresh-button" onclick="forceRefreshRooms()" title="ìƒˆë¡œê³ ì¹¨">ğŸ”„</button>
            </div>
            
            <div class="user-info">
                <div class="user-avatar" id="userAvatar"></div>
                <div>
                    <div id="userName"></div>
                    <div style="font-size: 12px; color: #666;">ì˜¨ë¼ì¸</div>
                </div>
            </div>

            <div class="room-list" id="roomList">
                <!-- ì±„íŒ…ë°© ëª©ë¡ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
            </div>
        </div>

        <!-- ë©”ì¸ ì±„íŒ… ì˜ì—­ -->
        <div class="chat-main">
            <div class="chat-header">
                <div class="chat-title" id="chatTitle">ì±„íŒ…ë°©ì„ ì„ íƒí•˜ì„¸ìš”</div>
            </div>

            <div class="chat-messages" id="chatMessages">
                <!-- ë©”ì‹œì§€ë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
            </div>

            <div class="typing-indicator" id="typingIndicator" style="display: none;">
                ëˆ„êµ°ê°€ ì…ë ¥ ì¤‘...
            </div>

            <div class="chat-input">
                <div class="input-container">
                    <textarea 
                        id="messageInput" 
                        class="message-input" 
                        placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."
                        rows="1"
                        onkeydown="handleKeyDown(event)"
                        oninput="handleTyping()"
                    ></textarea>
                    <button class="emoji-button" onclick="toggleEmojiPicker()">ğŸ˜Š</button>
                    <button id="sendButton" class="send-button" onclick="sendMessage()" disabled>ì „ì†¡</button>
                </div>
                
                <div id="emojiPicker" class="emoji-picker">
                    <div class="emoji-item" onclick="sendEmoji('ğŸ˜Š')">ğŸ˜Š</div>
                    <div class="emoji-item" onclick="sendEmoji('ğŸ˜‚')">ğŸ˜‚</div>
                    <div class="emoji-item" onclick="sendEmoji('â¤ï¸')">â¤ï¸</div>
                    <div class="emoji-item" onclick="sendEmoji('ğŸ‘')">ğŸ‘</div>
                    <div class="emoji-item" onclick="sendEmoji('ğŸ‘')">ğŸ‘</div>
                    <div class="emoji-item" onclick="sendEmoji('ğŸ‰')">ğŸ‰</div>
                    <div class="emoji-item" onclick="sendEmoji('ğŸ”¥')">ğŸ”¥</div>
                    <div class="emoji-item" onclick="sendEmoji('ğŸ˜­')">ğŸ˜­</div>
                    <div class="emoji-item" onclick="sendEmoji('ğŸ¤”')">ğŸ¤”</div>
                    <div class="emoji-item" onclick="sendEmoji('ğŸ˜')">ğŸ˜</div>
                    <div class="emoji-item" onclick="sendEmoji('ğŸ¥³')">ğŸ¥³</div>
                    <div class="emoji-item" onclick="sendEmoji('ğŸ˜´')">ğŸ˜´</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let socket;
        let currentUser = null;
        let currentRoom = null;
        let rooms = [];
        let typingTimeout;
        let roomUpdateInterval; // ì±„íŒ…ë°© ëª©ë¡ ì£¼ê¸°ì  ê°±ì‹ 
        let unreadCountInterval; // ì½ì§€ ì•Šì€ ë©”ì‹œì§€ ìˆ˜ ì£¼ê¸°ì  ê°±ì‹ 

        // ë¡œê·¸ì¸
        async function login() {
            const userId = document.getElementById('userIdInput').value.trim();
            const username = document.getElementById('usernameInput').value.trim();
            
            if (!userId || !username) {
                alert('ì‚¬ìš©ì IDì™€ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            try {
                const response = await fetch('/api/chat/users', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ userId, username })
                });

                if (response.ok) {
                    currentUser = { userId, username };
                    document.getElementById('loginScreen').classList.add('hidden');
                    document.getElementById('chatContainer').classList.remove('hidden');
                    document.getElementById('userName').textContent = username;
                    document.getElementById('userAvatar').textContent = username.charAt(0).toUpperCase();
                    
                    loadRooms();
                    startPeriodicUpdates();
                } else {
                    alert('ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('Login error:', error);
                alert('ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ì£¼ê¸°ì  ì—…ë°ì´íŠ¸ ì‹œì‘
        function startPeriodicUpdates() {
            // ì±„íŒ…ë°© ëª©ë¡ 2ì´ˆë§ˆë‹¤ ê°±ì‹  (ë” ìì£¼)
            roomUpdateInterval = setInterval(() => {
                if (currentUser) {
                    console.log('ì£¼ê¸°ì  ì±„íŒ…ë°© ëª©ë¡ ê°±ì‹  ì‹¤í–‰...');
                    loadRooms();
                }
            }, 2000);

            // ì½ì§€ ì•Šì€ ë©”ì‹œì§€ ìˆ˜ 1ì´ˆë§ˆë‹¤ ê°±ì‹  (ë” ìì£¼)
            unreadCountInterval = setInterval(() => {
                if (currentUser) {
                    updateUnreadCounts();
                }
            }, 1000);

            // í˜ì´ì§€ í¬ì»¤ìŠ¤ ì‹œ ì¦‰ì‹œ ê°±ì‹ 
            document.addEventListener('visibilitychange', () => {
                if (!document.hidden && currentUser) {
                    console.log('í˜ì´ì§€ í¬ì»¤ìŠ¤ ì‹œ ì±„íŒ…ë°© ëª©ë¡ ê°±ì‹ ');
                    loadRooms();
                    updateUnreadCounts();
                }
            });

            // ë¸Œë¼ìš°ì € íƒ­ í™œì„±í™” ì‹œ ê°±ì‹ 
            window.addEventListener('focus', () => {
                if (currentUser) {
                    console.log('ë¸Œë¼ìš°ì € íƒ­ í™œì„±í™” ì‹œ ì±„íŒ…ë°© ëª©ë¡ ê°±ì‹ ');
                    loadRooms();
                    updateUnreadCounts();
                }
            });
        }

        // ì½ì§€ ì•Šì€ ë©”ì‹œì§€ ìˆ˜ ì—…ë°ì´íŠ¸
        async function updateUnreadCounts() {
            try {
                const response = await fetch(`/api/notifications/unread-counts?userId=${currentUser.userId}`);
                const unreadCounts = await response.json();
                
                // ì±„íŒ…ë°© ëª©ë¡ì˜ ì½ì§€ ì•Šì€ ë©”ì‹œì§€ ìˆ˜ ì—…ë°ì´íŠ¸
                let hasChanges = false;
                rooms.forEach(room => {
                    const unreadCount = unreadCounts[room.roomId] || 0;
                    if (room.unreadCount !== unreadCount) {
                        room.unreadCount = unreadCount;
                        hasChanges = true;
                        console.log(`ì±„íŒ…ë°© ${room.roomName}ì˜ ì½ì§€ ì•Šì€ ë©”ì‹œì§€ ìˆ˜: ${unreadCount}`);
                    }
                });
                
                if (hasChanges) {
                    renderRoomList();
                }
            } catch (error) {
                console.error('Update unread counts error:', error);
            }
        }

        // ì±„íŒ…ë°© ëª©ë¡ ë¡œë“œ
        async function loadRooms() {
            try {
                console.log('ì±„íŒ…ë°© ëª©ë¡ ë¡œë“œ ì‹œì‘...');
                const response = await fetch(`/api/chat/rooms?userId=${currentUser.userId}`);
                const newRooms = await response.json();
                console.log('ì„œë²„ì—ì„œ ë°›ì€ ì±„íŒ…ë°© ëª©ë¡:', newRooms);
                
                // ìƒˆ ì±„íŒ…ë°©ì´ ìˆëŠ”ì§€ í™•ì¸ (ë” ì •í™•í•œ ë¹„êµ)
                const hasNewRooms = newRooms.length !== rooms.length || 
                    newRooms.some((newRoom, index) => {
                        const oldRoom = rooms[index];
                        const isDifferent = !oldRoom || 
                               newRoom.roomId !== oldRoom.roomId || 
                               newRoom.lastMessage !== oldRoom.lastMessage ||
                               newRoom.lastMessageTime !== oldRoom.lastMessageTime ||
                               newRoom.roomName !== oldRoom.roomName;
                        
                        if (isDifferent) {
                            console.log('ë³€ê²½ëœ ì±„íŒ…ë°© ë°œê²¬:', { old: oldRoom, new: newRoom });
                        }
                        return isDifferent;
                    });
                
                if (hasNewRooms) {
                    console.log('ì±„íŒ…ë°© ëª©ë¡ ë³€ê²½ ê°ì§€, UI ì—…ë°ì´íŠ¸ ì¤‘...');
                    rooms = newRooms;
                    renderRoomList();
                    console.log('ì±„íŒ…ë°© ëª©ë¡ì´ ê°±ì‹ ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    
                    // ìƒˆë¡œ ì¶”ê°€ëœ ì±„íŒ…ë°©ì´ ìˆìœ¼ë©´ ìë™ìœ¼ë¡œ ì²« ë²ˆì§¸ ì±„íŒ…ë°©ì— ì—°ê²°
                    if (!currentRoom && rooms.length > 0) {
                        console.log('ì²« ë²ˆì§¸ ì±„íŒ…ë°©ì— ìë™ ì—°ê²°:', rooms[0].roomName);
                        joinRoom(rooms[0]);
                    }
                } else {
                    console.log('ì±„íŒ…ë°© ëª©ë¡ ë³€ê²½ ì—†ìŒ');
                }
                
                return rooms; // Promise ê²°ê³¼ë¡œ ë°˜í™˜
            } catch (error) {
                console.error('Load rooms error:', error);
                return rooms; // ì—ëŸ¬ ì‹œì—ë„ ê¸°ì¡´ ëª©ë¡ ë°˜í™˜
            }
        }

        // ì±„íŒ…ë°© ëª©ë¡ ë Œë”ë§
        function renderRoomList() {
            const roomList = document.getElementById('roomList');
            roomList.innerHTML = '';

            rooms.forEach(room => {
                const roomItem = document.createElement('div');
                roomItem.className = 'room-item';
                roomItem.onclick = () => joinRoom(room);
                
                // ì½ì§€ ì•Šì€ ë©”ì‹œì§€ ìˆ˜ í‘œì‹œ
                const unreadBadge = room.unreadCount > 0 ? 
                    `<span class="unread-badge">${room.unreadCount}</span>` : '';
                
                // ë§ˆì§€ë§‰ ë©”ì‹œì§€ ì‹œê°„ í‘œì‹œ
                const lastMessageTime = room.lastMessageTime ? 
                    formatMessageTime(new Date(room.lastMessageTime)) : '';
                
                roomItem.innerHTML = `
                    <div class="room-header">
                        <div class="room-name">${room.roomName}</div>
                        <div class="room-time">${lastMessageTime}</div>
                    </div>
                    <div class="room-content">
                        <div class="room-last-message">${room.lastMessage || 'ìƒˆë¡œìš´ ì±„íŒ…ë°©ì…ë‹ˆë‹¤.'}</div>
                        ${unreadBadge}
                    </div>
                `;
                
                roomList.appendChild(roomItem);
            });
        }

        // ë©”ì‹œì§€ ì‹œê°„ í¬ë§·íŒ…
        function formatMessageTime(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
            
            if (diffDays === 0) {
                return date.toLocaleTimeString('ko-KR', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } else if (diffDays === 1) {
                return 'ì–´ì œ';
            } else if (diffDays < 7) {
                return `${diffDays}ì¼ ì „`;
            } else {
                return date.toLocaleDateString('ko-KR', {
                    month: 'short',
                    day: 'numeric'
                });
            }
        }

        // ì±„íŒ…ë°© ì°¸ê°€
        function joinRoom(room) {
            console.log('ì±„íŒ…ë°© ì°¸ê°€ ì‹œë„:', room.roomName, room.roomId);
            
            // ê¸°ì¡´ WebSocket ì—°ê²°ì´ ìˆìœ¼ë©´ ì •ìƒì ìœ¼ë¡œ ì¢…ë£Œ
            if (socket && socket.readyState === WebSocket.OPEN) {
                console.log('ê¸°ì¡´ WebSocket ì—°ê²° ì¢…ë£Œ ì¤‘...');
                socket.close(1000, 'ìƒˆ ì±„íŒ…ë°©ìœ¼ë¡œ ì´ë™');
            }

            currentRoom = room;
            document.getElementById('chatTitle').textContent = room.roomName;
            document.getElementById('chatMessages').innerHTML = '';
            
            // WebSocket ì—°ê²°
            connectWebSocket(room);
            
            // ì±„íŒ…ë°© ëª©ë¡ì—ì„œ í™œì„± ìƒíƒœ í‘œì‹œ
            document.querySelectorAll('.room-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // í´ë¦­ëœ ì±„íŒ…ë°© ì•„ì´í…œ ì°¾ê¸°
            const roomItems = document.querySelectorAll('.room-item');
            for (let item of roomItems) {
                const roomNameElement = item.querySelector('.room-name');
                if (roomNameElement && roomNameElement.textContent === room.roomName) {
                    item.classList.add('active');
                    break;
                }
            }
        }

        // WebSocket ì—°ê²° í•¨ìˆ˜
        function connectWebSocket(room) {
            console.log('=== WebSocket ì—°ê²° ì‹œë„ ì‹œì‘ ===');
            console.log('ì—°ê²° URL:', `ws://localhost:8081/ws/chat?roomId=${room.roomId}&userId=${currentUser.userId}`);
            console.log('í˜„ì¬ ì‚¬ìš©ì:', currentUser);
            console.log('ì„ íƒëœ ì±„íŒ…ë°©:', room);
            
            // ê¸°ì¡´ ì—°ê²°ì´ ìˆìœ¼ë©´ ì™„ì „íˆ ì •ë¦¬
            if (socket) {
                console.log('ê¸°ì¡´ WebSocket ì—°ê²° ì •ë¦¬ ì¤‘...');
                socket.onclose = null;
                socket.onerror = null;
                socket.onmessage = null;
                socket.onopen = null;
            }
            
            socket = new WebSocket(`ws://localhost:8081/ws/chat?roomId=${room.roomId}&userId=${currentUser.userId}`);
            
            socket.onopen = function() {
                console.log('=== WebSocket ì—°ê²° ì„±ê³µ ===');
                console.log('ì—°ê²°ëœ ì±„íŒ…ë°©:', room.roomName);
                console.log('ì—°ê²°ëœ ì‚¬ìš©ì:', currentUser.userId);
                console.log('WebSocket ìƒíƒœ:', socket.readyState);
                loadMessages();
                
                // ì½ì§€ ì•Šì€ ë©”ì‹œì§€ ìˆ˜ ì´ˆê¸°í™”
                room.unreadCount = 0;
                renderRoomList();
            };
            
            socket.onmessage = function(event) {
                console.log('=== WebSocket ë©”ì‹œì§€ ìˆ˜ì‹  ===');
                console.log('ì›ë³¸ ë°ì´í„°:', event.data);
                try {
                    const data = JSON.parse(event.data);
                    console.log('íŒŒì‹±ëœ ë°ì´í„°:', data);
                    handleMessage(data);
                } catch (error) {
                    console.error('ë©”ì‹œì§€ íŒŒì‹± ì˜¤ë¥˜:', error);
                }
            };
            
            socket.onclose = function(event) {
                console.log('=== WebSocket ì—°ê²° ì¢…ë£Œ ===');
                console.log('ì¢…ë£Œ ì½”ë“œ:', event.code);
                console.log('ì¢…ë£Œ ì´ìœ :', event.reason);
                console.log('ì •ìƒ ì¢…ë£Œ ì—¬ë¶€:', event.wasClean);
                
                // ì •ìƒ ì¢…ë£Œê°€ ì•„ë‹Œ ê²½ìš°ì—ë§Œ ì¬ì—°ê²° ì‹œë„
                if (event.code !== 1000 && currentRoom && currentRoom.roomId === room.roomId) {
                    console.log('ë¹„ì •ìƒ ì¢…ë£Œë¡œ ì¸í•œ ì¬ì—°ê²° ì‹œë„...');
                    setTimeout(() => {
                        if (currentRoom && currentRoom.roomId === room.roomId) {
                            console.log('WebSocket ì¬ì—°ê²° ì‹œë„...');
                            connectWebSocket(currentRoom);
                        }
                    }, 3000);
                }
            };
            
            socket.onerror = function(error) {
                console.error('=== WebSocket ì˜¤ë¥˜ ===');
                console.error('ì˜¤ë¥˜ ìƒì„¸:', error);
                console.error('WebSocket ìƒíƒœ:', socket.readyState);
            };
        }

        // ë©”ì‹œì§€ ë¡œë“œ
        async function loadMessages() {
            try {
                const response = await fetch(`/api/chat/rooms/${currentRoom.roomId}/messages?size=50`);
                const data = await response.json();
                
                data.content.reverse().forEach(message => {
                    addMessageToUI(message);
                });
                
                scrollToBottom();
            } catch (error) {
                console.error('Load messages error:', error);
            }
        }

        // ë©”ì‹œì§€ ì²˜ë¦¬
        function handleMessage(data) {
            console.log('WebSocket ë©”ì‹œì§€ ìˆ˜ì‹ :', data);
            
            switch (data.type) {
                case 'message':
                    addMessageToUI(data);
                    scrollToBottom();
                    
                    // ë©”ì‹œì§€ ìˆ˜ì‹  ì‹œ ì¦‰ì‹œ ì±„íŒ…ë°© ëª©ë¡ ê°±ì‹ 
                    console.log('ë©”ì‹œì§€ ìˆ˜ì‹ ìœ¼ë¡œ ì¸í•œ ì±„íŒ…ë°© ëª©ë¡ ê°±ì‹  ì‹œì‘');
                    setTimeout(() => {
                        loadRooms().then(() => {
                            // ìƒˆ ë©”ì‹œì§€ê°€ ì˜¨ ì±„íŒ…ë°©ì´ ëª©ë¡ì— ì—†ìœ¼ë©´ ê°•ì œë¡œ ë‹¤ì‹œ ë¡œë“œ
                            const messageRoom = rooms.find(room => room.roomId === data.roomId);
                            if (!messageRoom) {
                                console.log('ìƒˆ ë©”ì‹œì§€ê°€ ì˜¨ ì±„íŒ…ë°©ì´ ëª©ë¡ì— ì—†ìŒ, ê°•ì œ ì¬ë¡œë“œ');
                                loadRooms();
                            } else {
                                console.log('ì±„íŒ…ë°© ëª©ë¡ì— ë©”ì‹œì§€ê°€ ì˜¨ ì±„íŒ…ë°© í™•ì¸ë¨:', messageRoom.roomName);
                            }
                        });
                    }, 100);
                    break;
                case 'system':
                    console.log('ì‹œìŠ¤í…œ ë©”ì‹œì§€ ì²˜ë¦¬:', data.content);
                    addSystemMessage(data.content);
                    break;
                case 'typing':
                    console.log('íƒ€ì´í•‘ ì¸ë””ì¼€ì´í„° ì²˜ë¦¬:', data);
                    handleTypingIndicator(data);
                    break;
                case 'emoji':
                    console.log('ì´ëª¨í‹°ì½˜ ë©”ì‹œì§€ ì²˜ë¦¬:', data);
                    addEmojiMessage(data);
                    break;
                case 'unreadCount':
                    console.log('ì½ì§€ ì•Šì€ ë©”ì‹œì§€ ìˆ˜ ì—…ë°ì´íŠ¸:', data.count);
                    // í˜„ì¬ ì±„íŒ…ë°©ì˜ ì½ì§€ ì•Šì€ ë©”ì‹œì§€ ìˆ˜ ì—…ë°ì´íŠ¸
                    if (currentRoom) {
                        currentRoom.unreadCount = data.count;
                        renderRoomList();
                    }
                    break;
                case 'notification':
                    console.log('ì‹¤ì‹œê°„ ì•Œë¦¼ ìˆ˜ì‹ :', data);
                    showNotification(data);
                    break;
                case 'roomUpdate':
                    console.log('ì±„íŒ…ë°© ì—…ë°ì´íŠ¸ ì´ë²¤íŠ¸ ìˆ˜ì‹ :', data);
                    // ì±„íŒ…ë°© ëª©ë¡ ê°±ì‹ 
                    if (data.action === 'messageReceived') {
                        setTimeout(() => {
                            loadRooms();
                        }, 100);
                    }
                    break;
                default:
                    console.log('ì•Œ ìˆ˜ ì—†ëŠ” ë©”ì‹œì§€ íƒ€ì…:', data.type, data);
            }
        }

        // ì‹¤ì‹œê°„ ì•Œë¦¼ í‘œì‹œ
        function showNotification(data) {
            console.log('ì‹¤ì‹œê°„ ì•Œë¦¼ í‘œì‹œ:', data);
            
            // ë¸Œë¼ìš°ì € ì•Œë¦¼ í‘œì‹œ
            if (Notification.permission === 'granted') {
                const notification = new Notification('ìƒˆ ë©”ì‹œì§€', {
                    body: `${data.senderName}: ${data.content}`,
                    icon: '/favicon.ico',
                    tag: data.roomId
                });
                
                notification.onclick = function() {
                    window.focus();
                    // í•´ë‹¹ ì±„íŒ…ë°©ìœ¼ë¡œ ì´ë™
                    const targetRoom = rooms.find(room => room.roomId === data.roomId);
                    if (targetRoom) {
                        joinRoom(targetRoom);
                    }
                    notification.close();
                };
                
                // 5ì´ˆ í›„ ìë™ìœ¼ë¡œ ë‹«ê¸°
                setTimeout(() => {
                    notification.close();
                }, 5000);
            }
            
            // í† ìŠ¤íŠ¸ ì•Œë¦¼ í‘œì‹œ (ë¸Œë¼ìš°ì € ì•Œë¦¼ì´ ê±°ë¶€ëœ ê²½ìš°)
            showToastNotification(data);
        }
        
        // í† ìŠ¤íŠ¸ ì•Œë¦¼ í‘œì‹œ
        function showToastNotification(data) {
            // í† ìŠ¤íŠ¸ ì»¨í…Œì´ë„ˆê°€ ì—†ìœ¼ë©´ ìƒì„±
            let toastContainer = document.getElementById('toastContainer');
            if (!toastContainer) {
                toastContainer = document.createElement('div');
                toastContainer.id = 'toastContainer';
                toastContainer.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    z-index: 10000;
                    max-width: 300px;
                `;
                document.body.appendChild(toastContainer);
            }
            
            // í† ìŠ¤íŠ¸ ë©”ì‹œì§€ ìƒì„±
            const toast = document.createElement('div');
            toast.style.cssText = `
                background: #333;
                color: white;
                padding: 12px 16px;
                margin-bottom: 8px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                cursor: pointer;
                animation: slideIn 0.3s ease-out;
                font-size: 14px;
            `;
            
            toast.innerHTML = `
                <div style="font-weight: bold; margin-bottom: 4px;">${data.roomName}</div>
                <div style="color: #ccc;">${data.senderName}: ${data.content}</div>
            `;
            
            // í´ë¦­ ì‹œ í•´ë‹¹ ì±„íŒ…ë°©ìœ¼ë¡œ ì´ë™
            toast.onclick = function() {
                const targetRoom = rooms.find(room => room.roomId === data.roomId);
                if (targetRoom) {
                    joinRoom(targetRoom);
                }
                toast.remove();
            };
            
            toastContainer.appendChild(toast);
            
            // 5ì´ˆ í›„ ìë™ìœ¼ë¡œ ì œê±°
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.remove();
                }
            }, 5000);
        }

        // UIì— ë©”ì‹œì§€ ì¶”ê°€
        function addMessageToUI(message) {
            const chatMessages = document.getElementById('chatMessages');
            const isOwn = message.senderId === currentUser.userId;
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isOwn ? 'own' : 'other'}`;
            
            const time = new Date(message.sentAt).toLocaleTimeString('ko-KR', {
                hour: '2-digit',
                minute: '2-digit'
            });
            
            messageDiv.innerHTML = `
                <div class="message-avatar">${message.senderName.charAt(0).toUpperCase()}</div>
                <div class="message-content">
                    <div class="message-info">
                        <span>${message.senderName}</span>
                    </div>
                    <div>${message.content}</div>
                    <div class="message-time">${time}</div>
                </div>
            `;
            
            chatMessages.appendChild(messageDiv);
        }

        // ì‹œìŠ¤í…œ ë©”ì‹œì§€ ì¶”ê°€
        function addSystemMessage(content) {
            const chatMessages = document.getElementById('chatMessages');
            const systemDiv = document.createElement('div');
            systemDiv.className = 'system-message';
            systemDiv.textContent = content;
            chatMessages.appendChild(systemDiv);
            scrollToBottom();
        }

        // ì´ëª¨í‹°ì½˜ ë©”ì‹œì§€ ì¶”ê°€
        function addEmojiMessage(data) {
            const chatMessages = document.getElementById('chatMessages');
            const isOwn = data.senderId === currentUser.userId;
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isOwn ? 'own' : 'other'}`;
            
            const time = new Date(data.sentAt).toLocaleTimeString('ko-KR', {
                hour: '2-digit',
                minute: '2-digit'
            });
            
            messageDiv.innerHTML = `
                <div class="message-avatar">${data.senderName.charAt(0).toUpperCase()}</div>
                <div class="message-content">
                    <div class="message-info">
                        <span>${data.senderName}</span>
                    </div>
                    <div style="font-size: 24px;">${data.emoji}</div>
                    <div class="message-time">${time}</div>
                </div>
            `;
            
            chatMessages.appendChild(messageDiv);
            scrollToBottom();
        }

        // íƒ€ì´í•‘ ì¸ë””ì¼€ì´í„° ì²˜ë¦¬
        function handleTypingIndicator(data) {
            const typingIndicator = document.getElementById('typingIndicator');
            if (data.isTyping) {
                typingIndicator.textContent = `${data.username}ë‹˜ì´ ì…ë ¥ ì¤‘...`;
                typingIndicator.style.display = 'block';
            } else {
                typingIndicator.style.display = 'none';
            }
        }

        // ë©”ì‹œì§€ ì „ì†¡
        function sendMessage() {
            console.log('=== ë©”ì‹œì§€ ì „ì†¡ ì‹œì‘ ===');
            
            const input = document.getElementById('messageInput');
            const content = input.value.trim();
            
            console.log('ì…ë ¥ëœ ë©”ì‹œì§€:', content);
            console.log('WebSocket ì¡´ì¬ ì—¬ë¶€:', !!socket);
            console.log('WebSocket ìƒíƒœ:', socket ? socket.readyState : 'N/A');
            
            if (!content) {
                console.log('ë©”ì‹œì§€ê°€ ë¹„ì–´ìˆìŒ - ì „ì†¡ ì·¨ì†Œ');
                return;
            }
            
            if (!socket) {
                console.error('WebSocketì´ ì¡´ì¬í•˜ì§€ ì•ŠìŒ - ì „ì†¡ ì·¨ì†Œ');
                return;
            }
            
            if (socket.readyState !== WebSocket.OPEN) {
                console.error('WebSocketì´ ì—´ë ¤ìˆì§€ ì•ŠìŒ - ì „ì†¡ ì·¨ì†Œ');
                console.error('WebSocket ìƒíƒœ:', socket.readyState);
                return;
            }
            
            const message = {
                type: 'message',
                content: content,
                messageType: 'text'
            };
            
            console.log('ì „ì†¡í•  ë©”ì‹œì§€:', message);
            console.log('JSON ë¬¸ìì—´:', JSON.stringify(message));
            
            try {
                socket.send(JSON.stringify(message));
                console.log('âœ… ë©”ì‹œì§€ ì „ì†¡ ì„±ê³µ');
                input.value = '';
                input.style.height = 'auto';
                updateSendButton();
            } catch (error) {
                console.error('âŒ ë©”ì‹œì§€ ì „ì†¡ ì‹¤íŒ¨:', error);
            }
        }

        // ì´ëª¨í‹°ì½˜ ì „ì†¡
        function sendEmoji(emoji) {
            if (!socket || socket.readyState !== WebSocket.OPEN) return;
            
            const message = {
                type: 'emoji',
                emoji: emoji
            };
            
            socket.send(JSON.stringify(message));
            toggleEmojiPicker();
        }

        // íƒ€ì´í•‘ ì²˜ë¦¬
        function handleTyping() {
            if (!socket || socket.readyState !== WebSocket.OPEN) return;
            
            clearTimeout(typingTimeout);
            
            socket.send(JSON.stringify({
                type: 'typing',
                isTyping: true
            }));
            
            typingTimeout = setTimeout(() => {
                socket.send(JSON.stringify({
                    type: 'typing',
                    isTyping: false
                }));
            }, 1000);
        }

        // í‚¤ë³´ë“œ ì´ë²¤íŠ¸ ì²˜ë¦¬
        function handleKeyDown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        // ì´ëª¨í‹°ì½˜ í”¼ì»¤ í† ê¸€
        function toggleEmojiPicker() {
            const picker = document.getElementById('emojiPicker');
            picker.classList.toggle('show');
        }

        // ì „ì†¡ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateSendButton() {
            const input = document.getElementById('messageInput');
            const sendButton = document.getElementById('sendButton');
            sendButton.disabled = !input.value.trim();
        }

        // ìŠ¤í¬ë¡¤ì„ ë§¨ ì•„ë˜ë¡œ
        function scrollToBottom() {
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // ì…ë ¥ í•„ë“œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        document.getElementById('messageInput').addEventListener('input', updateSendButton);

        // ì´ëª¨í‹°ì½˜ í”¼ì»¤ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
        document.addEventListener('click', function(event) {
            const picker = document.getElementById('emojiPicker');
            const emojiButton = event.target.closest('.emoji-button');
            
            if (!picker.contains(event.target) && !emojiButton) {
                picker.classList.remove('show');
            }
        });

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ê¸°ë³¸ ì±„íŒ…ë°© ìƒì„± (í…ŒìŠ¤íŠ¸ìš©)
        window.addEventListener('load', async function() {
            // ë¸Œë¼ìš°ì € ì•Œë¦¼ ê¶Œí•œ ìš”ì²­
            if (Notification.permission === 'default') {
                Notification.requestPermission();
            }
            
            // í…ŒìŠ¤íŠ¸ìš© ê¸°ë³¸ ì±„íŒ…ë°© ìƒì„±
            try {
                await fetch('/api/chat/rooms', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        roomName: 'ì¼ë°˜ ì±„íŒ…ë°©',
                        participants: ['user1', 'user2', 'user3']
                    })
                });
            } catch (error) {
                console.log('ê¸°ë³¸ ì±„íŒ…ë°© ìƒì„± ì‹¤íŒ¨ (ì´ë¯¸ ì¡´ì¬í•  ìˆ˜ ìˆìŒ)');
            }
        });

        // ê°•ì œ ì±„íŒ…ë°© ëª©ë¡ ê°±ì‹  (ìˆ˜ë™ í˜¸ì¶œìš©)
        function forceRefreshRooms() {
            console.log('ê°•ì œ ì±„íŒ…ë°© ëª©ë¡ ê°±ì‹  ì‹¤í–‰');
            if (currentUser) {
                loadRooms().then(() => {
                    updateUnreadCounts();
                });
            }
        }
    </script>
</body>
</html>
